@echo off
echo ğŸš€ IdeaSpark - Deployment Script
echo ================================
echo.

REM Check if Terraform has been applied
if not exist "terraform.tfstate" (
    echo âŒ Terraform state not found!
    echo    Please run: terraform init ^&^& terraform apply
    pause
    exit /b 1
)

echo ğŸ“Š Getting AWS credentials from Terraform...

REM Get outputs from Terraform
for /f "delims=" %%i in ('terraform output -raw aws_access_key_id 2^>nul') do set AWS_ACCESS_KEY=%%i
for /f "delims=" %%i in ('terraform output -raw aws_secret_access_key 2^>nul') do set AWS_SECRET_KEY=%%i
for /f "delims=" %%i in ('terraform output -raw amplify_app_id 2^>nul') do set AMPLIFY_APP_ID=%%i
for /f "delims=" %%i in ('terraform output -raw amplify_default_domain 2^>nul') do set APP_URL=%%i

if "%AWS_ACCESS_KEY%"=="" (
    echo âŒ Could not retrieve AWS credentials from Terraform
    pause
    exit /b 1
)

echo âœ… Retrieved AWS credentials

REM Update config.js
echo ğŸ”§ Updating configuration...

(
echo // AWS Configuration
echo // Auto-generated by deploy.bat - DO NOT COMMIT THIS FILE
echo export const AWS_CONFIG = {
echo   region: 'us-east-1',
echo   credentials: {
echo     accessKeyId: '%AWS_ACCESS_KEY%',
echo     secretAccessKey: '%AWS_SECRET_KEY%'
echo   }
echo };
echo.
echo export const TABLES = {
echo   IDEAS: 'ideaspark-ideas',
echo   GROUPS: 'ideaspark-groups'
echo };
) > src\config.js

echo âœ… Configuration updated

REM Build the application
echo.
echo ğŸ“¦ Building application...
call npm run build

if not exist "dist" (
    echo âŒ Build failed - dist directory not found
    pause
    exit /b 1
)

echo âœ… Build successful

echo.
echo ğŸš€ Deploying to AWS Amplify...
echo.
echo ğŸ“Š Amplify App ID: %AMPLIFY_APP_ID%
echo ğŸŒ App URL: %APP_URL%
echo.
echo âš ï¸  Manual deployment required:
echo    1. Go to: https://console.aws.amazon.com/amplify/
echo    2. Select your app: %AMPLIFY_APP_ID%
echo    3. Click "Deploy without Git"
echo    4. Upload the 'dist' folder
echo.
echo    Or use AWS CLI to deploy automatically
echo.

echo âœ… Build complete!
echo.
echo ğŸŒ Your app will be available at:
echo    %APP_URL%
echo.
echo ğŸ“Š Monitor deployment in AWS Console:
echo    https://console.aws.amazon.com/amplify/
echo.
echo ğŸ‰ Done!
pause
